name: Build and Publish Chocolatey Package

on:
  push:
    tags:
      - '*'
    branches:
      - '**'

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update files with version and checksum
        id: version
        shell: pwsh
        run: |
          $refType = "${{ github.ref_type }}"
          $refName = "${{ github.ref_name }}"

          if ($refType -eq 'tag') {
            # For tag builds, update nuspec + install script from the VirtIO tag.
            .\update-version.ps1 -VirtioVersion $refName
          } else {
            Write-Host "Non-tag build (${refType}: ${refName}). Skipping update-version.ps1 and packing current repo state."
          }

          # Read values for outputs (works for both tag and branch builds)
          $nuspecContent = Get-Content "virtio-drivers.nuspec" -Raw
          if ($nuspecContent -match '<version>(.*?)</version>') {
            $packageVersion = $Matches[1]
          } else {
            throw "Could not find <version> in virtio-drivers.nuspec"
          }

          $installContent = Get-Content "tools/chocolateyinstall.ps1" -Raw
          if ($installContent -match "url = '(.*?)'") {
            $url = $Matches[1]
          }
          if ($installContent -match "checksum = '(.*?)'") {
            $checksum = $Matches[1]
          }

          $virtioVersion = $null
          if ($refType -eq 'tag') {
            $virtioVersion = $refName
          } else {
            if (Test-Path "version.json") {
              $vj = Get-Content "version.json" -Raw | ConvertFrom-Json
              if ($vj.virtio_version) { $virtioVersion = $vj.virtio_version }
            }
            if (-not $virtioVersion) { $virtioVersion = "(branch build)" }
          }

          echo "VERSION=$packageVersion" >> $env:GITHUB_OUTPUT
          echo "VIRTIO_VERSION=$virtioVersion" >> $env:GITHUB_OUTPUT
          echo "URL=$url" >> $env:GITHUB_OUTPUT
          echo "CHECKSUM=$checksum" >> $env:GITHUB_OUTPUT
          echo "CHECKSUM_TYPE=sha512" >> $env:GITHUB_OUTPUT

          Write-Host "Package Version: $packageVersion"
          Write-Host "VirtIO Version: $virtioVersion"

      - name: Install Chocolatey
        shell: pwsh
        run: |
          if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }

      - name: Pack Chocolatey package
        shell: pwsh
        run: |
          choco pack virtio-drivers.nuspec

      - name: Test package locally
        shell: pwsh
        run: |
          $package = Get-ChildItem -Filter "virtio-drivers.${{ steps.version.outputs.VERSION }}.nupkg"
          Write-Host "Package created: $($package.Name)"
          Write-Host "Package size: $($package.Length) bytes"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: virtio-drivers-${{ steps.version.outputs.VERSION }}-${{ github.ref_name }}
          path: virtio-drivers.${{ steps.version.outputs.VERSION }}.nupkg

      - name: Publish to Chocolatey Community Repository
        if: github.ref_type == 'tag'
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if ($env:CHOCO_API_KEY) {
            choco push virtio-drivers.${{ steps.version.outputs.VERSION }}.nupkg --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY
          } else {
            Write-Host "CHOCO_API_KEY secret not set. Skipping publish."
          }

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $body = @"
          VirtIO Drivers Chocolatey Package
          
          **VirtIO Version:** ${{ steps.version.outputs.VIRTIO_VERSION }}
          **Package Version:** ${{ steps.version.outputs.VERSION }}
          **ISO URL:** ${{ steps.version.outputs.URL }}
          **ISO SHA512 Checksum:** ${{ steps.version.outputs.CHECKSUM }}
          
          Install with: ``choco install virtio-drivers --version=${{ steps.version.outputs.VERSION }}``
          "@
          
          gh release create "${{ github.ref_name }}" `
            --title "VirtIO Drivers ${{ steps.version.outputs.VERSION }}" `
            --notes $body `
            virtio-drivers.${{ steps.version.outputs.VERSION }}.nupkg
